# Tmux configuration
#
# Greatly inspired from :
#   - https://github.com/gpakosz/.tmux
#   - https://github.com/samoshkin/tmux-config

# General TMUX configuration
# =============================================================================

# Set the default value of the TERM environment variable.
set -g default-terminal "screen-256color"
if 'infocmp -x tmux-256color &> /dev/null' \
  'set -g default-terminal "tmux-256color"'

# Set the time in milliseconds for which tmux waits after an escape is input to
# determine if it is part of a function or meta key sequences.
set -g escape-time 10

# Allow multiple commands to be entered without pressing the prefix-key again in
# the specified time milliseconds (the default is 500).
set -g repeat-time 500

# Set the maximum number of lines held in window history.
set -g history-limit 20000

# Set the amount of time for which status line messages and other on-screen
# indicators are displayed.
set -g display-time 5000

# A pane with this flag set is not destroyed when the program running in it
# exits.
set -g remain-on-exit off

# Allow programs in the pane to change the window name using a terminal escape
# sequence (\ek...\e\\).
setw -g allow-rename off

# Control automatic window renaming.
setw -g automatic-rename off

# Aggressively resize the chosen window.
setw -g aggressive-resize on

# Attempt to set the client terminal title#
set -g set-titles on

# String used to set the client terminal title if set-titles is on.
set -g set-titles-string "#S:#W"

# Set the base index from which an unused index should be searched when a new
# window is created.
set -g base-index 1

# Like base-index, but set the starting index for pane numbers.
setw -g pane-base-index 1

# If on, when a window is closed in a session, automatically renumber the other
# windows in numerical order.
set -g renumber-windows on

# Set the time in milliseconds for which the indicators shown by the
# display-panes command appear.
set -g display-panes-time 1000

# Update the status line every interval seconds.
set -g status-interval 5

# If on, tmux captures the mouse and allows mouse events to be bound as key
# bindings.
set -g mouse on

# If on, display a message instead of sending a bell when activity occurs in a
# window for which the monitor-activity window option is enabled.  If set to
# both, a bell and a message are produced.
set -g visual-activity on

# Allowing xterm sequence such as Ctrl+Left-Arrow behave differently from just
# Left-Arrow
setw -g xterm-keys on

# Set Alt-a (Meta-a) as the secondary prefix making C-b and M-a equivalent.
set -g prefix2 M-a

# Key bindings
# =============================================================================
# Unbind default key bindings, we're going to override
#unbind -a
unbind "\$" # rename-session
unbind ,    # rename-window
unbind %    # split-window -h
unbind '"'  # split-window
#unbind }    # swap-pane -D
#unbind {    # swap-pane -U
#  unbind [    # paste-buffer
#  unbind ]
#  unbind "'"  # select-window
unbind n    # next-window
unbind p    # previous-window
unbind l    # last-window
#  unbind M-n  # next window with alert
#  unbind M-p  # next window with alert
#  unbind o    # focus thru panes
#  unbind &    # kill-window
#  unbind "#"  # list-buffer
#  unbind =    # choose-buffer
#  unbind z    # zoom-pane
#  unbind M-Up  # resize 5 rows up
#  unbind M-Down # resize 5 rows down
#  unbind M-Right # resize 5 rows right
#  unbind M-Left # resize 5 rows left


# Reload tmux configuration
bind M-r source-file ~/.tmux.conf \; # display "Config reloaded"

# New window and retain cwd
bind c new-window -c "#{pane_current_path}"
bind -n M-t new-window -c "#{pane_current_path}"

# Rename session and window
bind r command-prompt -I "#{window_name}" "rename-window '%%'"
bind R command-prompt -I "#{session_name}" "rename-session '%%'"

# Split panes
# Warning !!! Vertical/Horizontal shortcuts are inversed. My inner logic is
# based from the orientation of the split line (i.e. when splitting vertically,
# the split line is horizontal and vice-versa).
bind v split-window -h -c "#{pane_current_path}"
bind h split-window -v -c "#{pane_current_path}"

# Select pane and windows
bind -r M-j next-window
bind -r M-k previous-window
bind -n -r M-Tab last-window
bind -r L swap-pane -U
bind -r H swap-pane -D

# Pane resize and zoom
bind -n -r M-h resize-pane -L 5
bind -n -r M-j resize-pane -D 5
bind -n -r M-k resize-pane -U 5
bind -n -r M-l resize-pane -R 5
bind -n -r M-m resize-pane -Z

# Kill pane/window/session shortcuts
bind -n M-w confirm-before -p "Kill pane #P? (y/n)" "kill-pane"
bind -n M-q confirm-before -p "Kill windows #W? (y/n)" "kill-window"
bind -n M-x confirm-before -p "Kill session #S? (y/n)" "kill-session"

# Detach from session
bind d detach
bind D if -F '#{session_many_attached}' \
  'confirm-before -p "Detach other clients? (y/n)" "detach -a"' \
  'detach'

# Window monitoring for activity and silence
# =============================================================================
# When enabled, focus events are requested from the terminal if supported and
# passed through to applications running in tmux.
set focus-events on

# Monitor for activity in the window. Windows with activity are highlighted in
# the status line.
set -g monitor-activity off
bind m setw monitor-activity \; \
  display 'Monitor window activity [#{?monitor-activity,ON,OFF}]'

# Monitor for silence (no activity) in the window within interval seconds.
set -g monitor-silence 0
bind M if -F '#{monitor-silence}' \
    'setw monitor-silence 0 ; display-message "Monitor window silence [OFF]"' \
    'command-prompt -p "Monitor silence: interval (s)" "setw monitor-silence %%"'

# Copy mode, history, scroll and clipboard
# =============================================================================
set -g @copy_use_osc52_fallback on

# Use vi or emacs-style key bindings in copy mode.
set -g mode-keys vi

bind p paste-buffer
bind C-p choose-buffer

# Trigger copy-mode
bind -n M-Escape copy-mode

# Scroll up/down by 1 line, half screen, whole screen
# bind -T copy-mode-vi k send-keys -X scroll-up
# bind -T copy-mode-vi j send-keys -X scroll-down
# bind -T copy-mode-vi C-u send-keys -X halfpage-up
# bind -T copy-mode-vi C-d send-keys -X halfpage-down

# When scrolling with mouse wheel, reduce number of scrolled rows per tick to
# "2" (default is 5)
bind -T copy-mode-vi WheelUpPane    select-pane \; send-keys -X -N 2 scroll-up
bind -T copy-mode-vi WheelDownPane  select-pane \; send-keys -X -N 2 scroll-down

# Sele text
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi V send-keys -X rectangle-toggle
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel
bind -T copy-mode-vi Y send-keys -X copy-line

# Plugins
# =============================================================================
# Plugins Management
# -----------------------------------------------------------------------------
#  Tmux Plugin Manager
set -g @plugin 'tmux-plugins/tpm'

# Seamless navigation between tmux panes and vim splits
set -g @plugin 'christoomey/vim-tmux-navigator'

# Persists tmux environment across system restarts.
set -g @plugin 'tmux-plugins/tmux-resurrect'

# Continuous saving of tmux environment. Automatic restore when tmux is started.
# Automatic tmux start when computer is turned on.
set -g @plugin 'tmux-plugins/tmux-continuum'

# ðŸŽ§ Spotify plugin for tmux
set -g @plugin 'xamut/tmux-spotify'

# ðŸš€ Quickly open urls on your terminal screen!
set -g @plugin 'wfxr/tmux-fzf-url'

# Plugins Configuration
# -----------------------------------------------------------------------------

# Per host config / nesting local and remote sessions
# =============================================================================
# Load custom share config per host/user configuration
# Load per host/user configuration
custom_config_file="${HOME}/.local/share/tmux/tmux.conf"
if '[[ -f "$custom_config_file" ]]' \
    'source "$custom_config_file"' \
    'display "File $custom_config_file does not exists !"'

# Session is considered to be remote when we ssh into host
#if '[[ -n "${SSH_CLIENT}"  && -f "${HOME}/.config/tmux/tmux.remote.conf" ]]' \
#    'source "${HOME}/.config/tmux/tmux.remote.conf"' \
#    'display "File ~/.config/tmux/tmux.remote.conf does not exists !"'

# We want to have single prefix key "C-a", usable both for local and remote session
# we don't want to "C-a" + "a" approach either
# Idea is to turn off all key bindings and prefix handling on local session,
# so that all keystrokes are passed to inner/remote session

# see: toggle on/off all keybindings Â· Issue #237 Â· tmux/tmux - https://github.com/tmux/tmux/issues/237

## Also, change some visual styles when window keys are off
#bind -T root F12  \
#    set prefix None \;\
#    set key-table off \;\
#    set status-position top \;\
#    set status-style "fg=#ffffff,bg=#424242" \;\
#    set window-status-current-format "#[bg=636363,fg=#ffffff]#I:#W# #[default]" \;\
#    set window-status-current-style "fg=#ffffff,bg=#ff00ff" \;\
#    if -F '#{pane_in_mode}' 'send-keys -X cancel' \;\
#    refresh-client -S \;\
#
#bind -T off F12 \
#  set -u prefix \;\
#  set -u key-table \;\
#  set status-position bottom \;\
#  set -u status-style \;\
#  set -u window-status-current-style \;\
#  set -u window-status-current-format \;\
#  refresh-client -S
#

# Run plugins script
# =============================================================================
run '~/.config/tmux/plugins/tpm/tpm'
run '~/.config/tmux/plugins/tmux-sysstat/sysstat.tmux'

# ******************************************************************************
# VIM MODELINE
# vim: ft=tmux: fdm=indent
# ******************************************************************************
